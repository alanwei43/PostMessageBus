/*!
  * PostMessageBus v0.0.5
  * git+https://github.com/alanwei43/PostMessageBus.git
  * 
  * @author Alan Wei
  */
var e,n;e=this,n=function(e){"use strict";function n(e,n){if("string"!=typeof e)return e;for(var t=(n||[]).filter((function(e){return"string"==typeof e&&1===e.length})),r=e,o=function e(){var n=r[r.length-1]||"";if(!t.filter((function(e){return e===n})).length)return"break";r=r.substr(0,r.length-1)};r.length&&"break"!==o(););return r}function t(e){return(e||"")+Date.now().toString(16)+Math.random().toString(16).substring(2)}var r=window;function o(e,n,t,r,o){return{__eventId:e,msgId:n,command:t,type:r,data:o}}var a={serializer:function e(n){return JSON.stringify(n)},deserializer:function e(n){try{if("string"==typeof n)return JSON.parse(n);if(n&&n.__eventId)return n}catch(e){return{}}return{}}};function i(e,n,t,r){var o={};return"function"==typeof e?o=e(n,t,r):e&&"function"==typeof e[n]?o=e[n](t,r):console.warn(n+" \u6ca1\u6709\u5bf9\u5e94\u5b9e\u73b0"),o}e.generateBusToFrame=function s(e,c,f){var u=t(),d={frame:document.createElement("iframe"),eventId:u};if("string"!=typeof e)throw new Error("link \u4e0d\u80fd\u4e3a\u7a7a");function l(e){d.frame&&d.frame.contentWindow?d.frame.contentWindow.postMessage(a.serializer(e),f||"*"):console.warn("iframe is null")}d.frame.src=function m(e,t,r){if("string"!=typeof e)return e;if(null==r||""===r)return e;var o=["?","&","#"],a=e,i=e.split("#"),s="";return i.length>1&&(a=i[0],s=i.slice(1,i.length).join("#")),-1===(a=n(a,o)).indexOf("?")?a+="?":a+="&",a+="".concat(encodeURIComponent(t),"=").concat(encodeURIComponent(r)),s&&(a+="#"+s),n(a,o)}(e,"post-message-event-id",u);var v=[{id:"...",command:"command",callback:function e(){}}],g=new Proxy({},{get:function e(n,r){return function(e){return new Promise((function(n){var a={id:t(),command:r,callback:function e(t){n(t)}};v.push(a),l(o(u,a.id,r,"Request",e))}))}}}),p=new Promise((function(e,n){var t=function n(t){var r=a.deserializer(t.data);if(r.__eventId===u)if(r.command!==u){if("Request"===r.type){var s=i(c,r.command,r.data,g);Promise.resolve(s).then((function(e){l(o(u,r.msgId,r.command,"Response",e))}))}if("Response"===r.type){var f=v.filter((function(e){return null!==e})).filter((function(e){return e.command===r.command&&e.id===r.msgId}))[0];f&&f.callback?(f.callback(r.data),v[v.indexOf(f)]=null):console.warn("[".concat(location.host,"] message not match handler: "),r)}}else e({frame:d.frame,message:r,eventId:u,request:g})};d.frame.addEventListener("error",(function(e){r.removeEventListener("message",t),n(e)})),r.addEventListener("message",t)}));return p.frame=d.frame,p.eventId=d.eventId,p},e.generateBusToParent=function c(e,n){var s=new URLSearchParams(location.search).get("post-message-event-id");if(s){if(r.parent){var c=[{id:"...",command:"command",callback:function e(){}}],f=new Proxy({},{get:function e(n,r){return function(e){return new Promise((function(n){var a={id:t(),command:r,callback:function e(t){n(t)}};c.push(a),u(o(s,a.id,r,"Request",e))}))}}});return r.addEventListener("message",(function(n){if(n.data){var t=a.deserializer(n.data);if(t.__eventId!==s&&console.warn("event id not equal",n.data),"Request"===t.type){var r=i(e,t.command,t.data,f);Promise.resolve(r).then((function(e){u(o(t.__eventId,t.msgId,t.command,"Response",e))}))}if("Response"===t.type){var d=c.filter((function(e){return null!==e})).filter((function(e){return e.command===t.command&&e.id===t.msgId}))[0];d&&d.callback?(d.callback(t.data),c[c.indexOf(d)]=null):console.warn("[".concat(location.host,"] message not match handler: "),t)}}}),!1),function e(){u(o(s,s,s,"Request",{}))}(),f}console.warn("\u4e0d\u662fiframe\u73af\u5883")}else console.warn("URL\u53c2\u6570 post-message-event-id \u4e0d\u80fd\u4e3a\u7a7a");function u(e){r.parent.postMessage(a.serializer(e),n||"*")}},e.updateConfig=function f(e){var n=e.serializer,t=e.deserializer;"function"==typeof n&&(a.serializer=n),"function"==typeof t&&(a.deserializer=t)},Object.defineProperty(e,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((e=e||self).PostMessageBus={});