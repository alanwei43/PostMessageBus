/*!
  * PostMessageBus v0.0.1
  * git+https://github.com/alanwei43/PostMessageBus.git
  * 
  * @author 
  */
var e,n;e=this,n=function(e){"use strict";var n=window;function t(e){return(e||"")+Date.now().toString(16)+Math.random().toString(16).substring(2)}function r(e,n,t,r,a){return{__eventId:e,msgId:n,command:t,type:r,data:a}}var a={serializer:function e(n){return JSON.stringify(n)},deserializer:function e(n){try{if("string"==typeof n)return JSON.parse(n);if(n&&n.__eventId)return n}catch(e){return{}}return{}}};function o(e,n,t,r){var a={};return"function"==typeof e?a=e(n,t,r):"function"==typeof e[n]?a=e[n](t,r):console.warn(n+" \u6ca1\u6709\u5bf9\u5e94\u5b9e\u73b0"),a}e.generateBusToFrame=function i(e,c,s){var d=t(),f={frame:document.createElement("iframe"),eventId:d,ready:null};if("string"!=typeof e)throw new Error("link \u4e0d\u80fd\u4e3a\u7a7a");var u=-1===e.indexOf("?")?"?":"&";function m(e){f.frame&&f.frame.contentWindow?f.frame.contentWindow.postMessage(a.serializer(e),s||"*"):console.warn("iframe is null")}f.frame.src="".concat(e).concat(u).concat("post-message-event-id","=").concat(d);var l=[{id:"...",command:"command",callback:function e(){}}],v=new Proxy({},{get:function e(n,a){return function(e){return new Promise((function(n){var o={id:t(),command:a,callback:function e(t){n(t)}};l.push(o),m(r(d,o.id,a,"Request",e))}))}}});return f.ready=new Promise((function(e,t){var i=function n(t){var i=a.deserializer(t.data);if(i.__eventId===d){if("Request"===i.type){var s=o(c,i.command,i.data,v);i.command===d&&e({frame:f.frame,message:i,request:v}),m(r(d,i.msgId,i.command,"Response",s))}if("Response"===i.type){var u=l.filter((function(e){return null!==e})).filter((function(e){return e.command===i.command&&e.id===i.msgId}))[0];u&&u.callback?(u.callback(i.data),l[l.indexOf(u)]=null):console.warn("[".concat(location.host,"] message not match handler: "),i)}}};f.frame.addEventListener("error",(function(e){n.removeEventListener("message",i),t(e)})),n.addEventListener("message",i)})),f},e.generateBusToParent=function c(e,i){var c=new URLSearchParams(location.search).get("post-message-event-id");if(c){if(n.parent){var s=[{id:"...",command:"command",callback:function e(){}}],d=new Proxy({},{get:function e(n,a){return function(e){return new Promise((function(n){var o={id:t(),command:a,callback:function e(t){n(t)}};s.push(o),f(r(c,o.id,a,"Request",e))}))}}});return n.addEventListener("message",(function(n){var t=a.deserializer(n.data);if(t.__eventId!==c&&console.warn("event id not equal"),"Request"===t.type&&f(r(t.__eventId,t.msgId,t.command,"Response",o(e,t.command,t.data,d))),"Response"===t.type){var i=s.filter((function(e){return null!==e})).filter((function(e){return e.command===t.command&&e.id===t.msgId}))[0];i&&i.callback?(i.callback(t.data),s[s.indexOf(i)]=null):console.warn("[".concat(location.host,"] message not match handler: "),t)}}),!1),function e(){f(r(c,c,c,"Request",{}))}(),d}console.warn("\u4e0d\u662fiframe\u73af\u5883")}else console.warn("URL\u53c2\u6570 post-message-event-id \u4e0d\u80fd\u4e3a\u7a7a");function f(e){n.parent.postMessage(a.serializer(e),i||"*")}},e.updateConfig=function s(e){var n=e.serializer,t=e.deserializer;"function"==typeof n&&(a.serializer=n),"function"==typeof t&&(a.deserializer=t)},Object.defineProperty(e,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((e=e||self).PostMessageBus={});